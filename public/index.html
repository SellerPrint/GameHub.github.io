<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GameHub - Morpion Multijoueur</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
:root{
  --primary:#6C63FF;--primary-dark:#554fd8;--secondary:#FF6584;--accent:#36D1DC;
  --light:#fff;--dark:#2D2B55;--darker:#1E1E2E;--gray:#f0f0f0;--dark-gray:#3D3D5C;
  --success:#32c766;--danger:#ff5252;--warning:#ffb142;--info:#2e86de;
  --shadow:0 10px 30px rgba(0,0,0,.15);--shadow-lg:0 20px 40px rgba(0,0,0,.2);
  --transition:all .25s ease;--bounce:cubic-bezier(0.68,-0.55,0.265,1.55);--radius:12px;
  font-synthesis:none;
}
.dark-mode{--light:#1e1e2e;--dark:#f0f0f0;--gray:#2d2d3d;--shadow:0 10px 30px rgba(0,0,0,.5);}

*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:"Poppins","Segoe UI",sans-serif;
  background:linear-gradient(135deg,var(--primary),var(--accent));
  min-height:100vh;padding:20px;color:var(--dark);transition:var(--transition);line-height:1.6;
}
.container{max-width:1200px;margin:0 auto}

/* Header */
header{display:flex;justify-content:space-between;align-items:center;padding:20px 0;margin-bottom:32px;color:var(--light)}
.logo{display:flex;align-items:center;gap:12px;cursor:pointer}
.logo-icon{font-size:2.2rem;background:var(--light);color:var(--primary);width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);transition:var(--transition)}
.logo:hover .logo-icon{transform:rotate(15deg) scale(1.1)}
.logo-text{font-size:1.6rem;font-weight:700}
.logo-text span{color:var(--secondary)}
.header-controls{display:flex;gap:10px;align-items:center}
.user-info{display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.1);padding:8px 12px;border-radius:20px;backdrop-filter:blur(8px)}
.user-avatar{width:32px;height:32px;border-radius:50%;background:var(--secondary);display:flex;align-items:center;justify-content:center;color:var(--light);font-weight:700;font-size:0.875rem}
.user-name{font-weight:600;font-size:0.875rem}
.control-btn{background:rgba(255,255,255,.14);color:var(--light);border:0;width:44px;height:44px;border-radius:50%;font-size:1.1rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--transition)}
.control-btn:hover{transform:scale(1.06);background:rgba(255,255,255,.22)}

/* Navigation */
.nav-tabs{display:flex;background:rgba(255,255,255,.1);border-radius:var(--radius);padding:6px;margin-bottom:24px;backdrop-filter:blur(8px);gap:4px}
.nav-tab{flex:1;text-align:center;padding:12px;color:var(--light);cursor:pointer;border-radius:8px;font-weight:600;transition:var(--transition)}
.nav-tab.active{background:var(--light);color:var(--primary);box-shadow:var(--shadow)}

/* Hero */
.hero{padding:40px 20px;border-radius:var(--radius);background:rgba(255,255,255,.1);backdrop-filter:blur(8px);text-align:center;color:var(--light);box-shadow:var(--shadow);margin-bottom:24px}
.hero h1{font-size:2.6rem;margin-bottom:8px}
.hero p{opacity:.95;max-width:720px;margin:0 auto 18px;font-size:1.125rem}
.cta-button{background:var(--secondary);color:var(--light);border:0;padding:12px 22px;border-radius:50px;font-weight:700;cursor:pointer;display:inline-flex;gap:10px;align-items:center;box-shadow:0 6px 18px rgba(255,101,132,.28);transition:var(--transition)}
.cta-button:hover{transform:translateY(-3px);background:#ff4a6d}

/* Games Grid */
.games-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:18px}
.game-card{background:var(--light);border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);cursor:pointer;transition:var(--transition);display:flex;flex-direction:column}
.game-card:hover{transform:translateY(-8px)}
.game-image{height:140px;background:linear-gradient(135deg,var(--primary),var(--accent));display:flex;align-items:center;justify-content:center;font-size:3rem;color:var(--light)}
.game-content{padding:16px;flex:1}
.game-content h3{font-size:1.3rem;margin-bottom:6px;color:var(--dark)}
.game-content p{color:var(--dark-gray);margin-bottom:12px;font-size:0.875rem}
.game-stats{display:flex;justify-content:space-between;align-items:center;font-size:.9rem;color:var(--dark-gray)}
.online-dot{width:8px;height:8px;background:var(--success);border-radius:50%;display:inline-block;margin-right:8px;animation:pulse 2s infinite}

/* Leaderboard */
.leaderboard-container{background:var(--light);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow)}
.leaderboard-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.leaderboard-title{font-size:1.4rem;color:var(--primary)}
.leaderboard-filters{display:flex;gap:8px}
.filter-btn{padding:6px 12px;border-radius:6px;border:1px solid var(--gray);background:var(--light);cursor:pointer;transition:var(--transition);font-size:0.875rem}
.filter-btn.active{background:var(--primary);color:var(--light);border-color:var(--primary)}
.leaderboard-list{list-style:none}
.leaderboard-item{display:flex;align-items:center;padding:10px;border-radius:10px;margin-bottom:8px;background:var(--gray);transition:var(--transition)}
.leaderboard-item.you{background:rgba(108,99,255,.06);border-left:4px solid var(--primary)}
.rank{width:36px;text-align:center;font-weight:700;font-size:1.125rem}
.rank-1{color:gold}
.rank-2{color:silver}
.rank-3{color:#cd7f32}
.player-avatar{width:40px;height:40px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;color:var(--light);font-weight:700;margin-right:10px}
.player-name{font-weight:600;flex:1}
.player-score{font-weight:700;color:var(--primary)}

/* Game Containers */
.game-container{display:none;background:var(--light);padding:18px;border-radius:var(--radius);box-shadow:var(--shadow);margin-top:18px}
.game-container.active{display:block;animation:bounceIn .5s var(--bounce)}
.game-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.back-button,.reset-button,.instruction-button,.mode-button{background:var(--primary);color:var(--light);border:0;padding:9px 14px;border-radius:8px;cursor:pointer;font-weight:700;transition:var(--transition);display:flex;align-items:center;gap:6px}
.mode-button.active{background:var(--secondary)}
.game-title{color:var(--primary);font-size:1.3rem;flex:1;text-align:center}
.score-display{background:var(--gray);padding:8px 12px;border-radius:8px;font-weight:700;color:var(--dark)}
.game-mode-selector{display:flex;gap:8px;margin:12px 0}

/* Morpion */
.morpion-container{display:flex;flex-direction:column;align-items:center}
.board{display:grid;grid-template-columns:repeat(3,120px);gap:10px;margin:12px auto}
.cell{width:120px;height:120px;font-size:3rem;display:flex;align-items:center;justify-content:center;background:var(--gray);border-radius:12px;cursor:pointer;border:3px solid var(--primary);user-select:none;transition:var(--transition)}
.cell.x{color:var(--primary);animation:bounceIn .3s var(--bounce)}
.cell.o{color:var(--secondary);animation:bounceIn .3s var(--bounce)}
.cell.win{background:var(--success);color:var(--light);border-color:var(--success)}

/* Modal */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px)}
.modal.active{display:flex;animation:fadeIn .3s}
.modal-content{background:var(--light);border-radius:var(--radius);padding:1.5rem;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-lg);position:relative;animation:slideInUp .3s var(--bounce)}
.modal-close{position:absolute;top:1rem;right:1rem;background:none;border:0;font-size:1.5rem;cursor:pointer;color:var(--dark-gray)}
.modal-title{font-size:1.5rem;color:var(--primary);margin-bottom:1rem}

/* Toast */
.toast{position:fixed;top:20px;right:20px;background:var(--success);color:var(--light);padding:1rem;border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:1001;display:flex;align-items:center;gap:0.75rem;transform:translateX(150%);transition:transform .3s var(--bounce)}
.toast.show{transform:translateX(0)}
.toast.error{background:var(--danger)}
.toast.warning{background:var(--warning)}
.toast.info{background:var(--info)}
.toast-icon{font-size:1.5rem}

/* Chat */
.chat-container{background:var(--gray);border-radius:var(--radius);padding:1rem;margin-top:1rem;max-height:300px;display:flex;flex-direction:column}
.chat-messages{flex:1;overflow-y:auto;margin-bottom:1rem}
.chat-message{padding:0.5rem;margin-bottom:0.5rem;background:var(--light);border-radius:var(--radius)}
.chat-input{display:flex;gap:0.5rem}
.chat-input input{flex:1;padding:0.5rem;border:1px solid var(--gray);border-radius:var(--radius)}
.chat-input button{padding:0.5rem 1rem;background:var(--primary);color:var(--light);border:0;border-radius:var(--radius);cursor:pointer}

/* Forms */
.form-group{margin-bottom:1rem}
.form-group label{display:block;margin-bottom:0.5rem;font-weight:600}
.form-group input{width:100%;padding:0.75rem;border:1px solid var(--gray);border-radius:var(--radius);font-size:1rem}
.form-actions{display:flex;gap:0.5rem;margin-top:1.5rem}

/* Animations */
@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}
@keyframes slideInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
@keyframes bounceIn{0%{opacity:0;transform:scale(.3)}50%{opacity:1;transform:scale(1.05)}70%{transform:scale(.9)}100%{opacity:1;transform:scale(1)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}

/* Responsive */
@media (max-width:768px){
  .hero h1{font-size:2rem}
  .board{grid-template-columns:repeat(3,90px)}
  .cell{width:90px;height:90px;font-size:2.4rem}
  .game-header{flex-direction:column;align-items:stretch}
  .game-title{order:-1;margin-bottom:1rem}
}
@media (max-width:480px){
  .board{grid-template-columns:repeat(3,70px)}
  .cell{width:70px;height:70px;font-size:2rem}
  .nav-tabs{flex-direction:column}
  .games-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div class="logo" id="logo">
      <div class="logo-icon"><i class="fas fa-gamepad"></i></div>
      <div class="logo-text">Morpion<span>Hub</span></div>
    </div>
    <div class="header-controls">
      <div class="user-info" id="user-info" style="display:none">
        <div class="user-avatar" id="user-avatar">J</div>
        <div class="user-name" id="user-name">Joueur</div>
      </div>
      <button id="theme-toggle" class="control-btn" title="Changer le th√®me"><i class="fas fa-moon"></i></button>
      <button id="auth-btn" class="control-btn" title="Connexion"><i class="fas fa-user"></i></button>
    </div>
  </header>

  <div class="nav-tabs">
    <div class="nav-tab active" data-tab="home">Accueil</div>
    <div class="nav-tab" data-tab="games">Jouer</div>
    <div class="nav-tab" data-tab="multiplayer">Multijoueur</div>
  </div>

  <!-- HOME -->
  <section id="home" class="section active">
    <div class="hero">
      <h1>Bienvenue sur MorpionHub</h1>
      <p>Plateforme de morpion multijoueur avec chat en temps r√©el !</p>
      <button class="cta-button" id="start-btn"><i class="fas fa-play"></i> Commencer √† jouer</button>
    </div>
    <div class="games-grid">
      <div class="game-card" data-game="morpion">
        <div class="game-image"><i class="fas fa-times"></i></div>
        <div class="game-content">
          <h3>Morpion Multijoueur</h3>
          <p>Jouez contre l'IA ou affrontez d'autres joueurs en ligne.</p>
          <div class="game-stats">
            <div><span class="online-dot"></span><span id="morpion-players">0</span> joueurs</div>
            <div><i class="fas fa-star"></i> 4.8</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GAMES -->
  <section id="games" class="section">
    <h2 style="color:var(--light);text-align:center;margin-bottom:12px">Choisissez votre mode de jeu</h2>
    <div class="games-grid">
      <div class="game-card" data-game="morpion">
        <div class="game-image"><i class="fas fa-robot"></i></div>
        <div class="game-content">
          <h3>Morpion Solo</h3>
          <p>Affrontez l'IA √† diff√©rents niveaux de difficult√©.</p>
        </div>
      </div>
      <div class="game-card" data-game="morpion-multi">
        <div class="game-image" style="background:linear-gradient(135deg,#FF6584,#FF9E7D)"><i class="fas fa-users"></i></div>
        <div class="game-content">
          <h3>Morpion Multijoueur</h3>
          <p>Jouez contre de vrais adversaires en temps r√©el.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MULTIPLAYER -->
  <section id="multiplayer" class="section">
    <h2 style="color:var(--light);text-align:center;margin-bottom:12px">Multijoueur en Temps R√©el</h2>
    <div class="games-grid">
      <div class="game-card" data-game="morpion-multi">
        <div class="game-image" style="background:linear-gradient(135deg,#FF6584,#FF9E7D)"><i class="fas fa-users"></i></div>
        <div class="game-content">
          <h3>Salle Morpion Multijoueur</h3>
          <p>Rejoignez une partie en ligne avec chat int√©gr√©.</p>
          <div class="game-stats">
            <div><span class="online-dot"></span><span id="morpion-online">0</span> en ligne</div>
            <div><button class="cta-button join-room" data-game="morpion" style="padding:6px 10px;font-size:.9rem">Rejoindre</button></div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GAME CONTAINER - MORPION -->
  <div id="morpion" class="game-container" aria-hidden="true">
    <div class="game-header">
      <button class="back-button" id="morpion-back"><i class="fas fa-arrow-left"></i> Retour</button>
      <div class="game-title">Morpion</div>
      <div class="score-display">Score: <span id="morpion-score">0</span></div>
      <button class="reset-button" id="morpion-reset"><i class="fas fa-redo"></i> Nouvelle partie</button>
    </div>
    
    <div class="game-mode-selector">
      <button class="mode-button active" data-mode="robot-easy"><i class="fas fa-robot"></i> Facile</button>
      <button class="mode-button" data-mode="robot-medium"><i class="fas fa-robot"></i> Moyen</button>
      <button class="mode-button" data-mode="robot-hard"><i class="fas fa-robot"></i> Difficile</button>
      <button class="mode-button" data-mode="online"><i class="fas fa-wifi"></i> En Ligne</button>
    </div>
    
    <div class="morpion-container">
      <div id="morpion-status" style="font-size:1.1rem;text-align:center;margin:10px 0">Tour du joueur X</div>
      <div id="morpion-board" class="board"></div>
      <div id="online-players" style="margin-top:12px;text-align:center;display:none">
        <div><span class="online-dot"></span> <span id="player-count">1</span> joueur(s) en ligne</div>
      </div>
      <div id="morpion-chat" class="chat-container" style="display:none">
        <div class="chat-messages" id="morpion-chat-messages"></div>
        <div class="chat-input">
          <input type="text" id="morpion-chat-input" placeholder="Tapez votre message...">
          <button id="morpion-chat-send">Envoyer</button>
        </div>
      </div>
    </div>
  </div>

</div>

<!-- Modals -->
<div id="auth-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close">&times;</button>
    <h2 class="modal-title" id="auth-modal-title">Connexion</h2>
    <div id="auth-form">
      <div class="form-group">
        <label for="auth-username">Nom d'utilisateur:</label>
        <input type="text" id="auth-username" placeholder="Votre nom d'utilisateur">
      </div>
      <div class="form-group">
        <label for="auth-password">Mot de passe:</label>
        <input type="password" id="auth-password" placeholder="Votre mot de passe">
      </div>
      <div class="form-actions">
        <button class="cta-button" id="auth-submit" style="flex:1">Se connecter</button>
        <button class="cta-button" id="auth-switch" style="background:var(--gray);color:var(--dark)">Cr√©er un compte</button>
      </div>
    </div>
  </div>
</div>

<div id="profile-modal" class="modal">
  <div class="modal-content">
    <button class="modal-close">&times;</button>
    <h2 class="modal-title">Profil Utilisateur</h2>
    <div class="user-stats">
      <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-bottom:1.5rem">
        <div class="stat-card">
          <div class="stat-value" id="total-games">0</div>
          <div class="stat-label">Parties jou√©es</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="win-rate">0%</div>
          <div class="stat-label">Taux de victoire</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="total-score">0</div>
          <div class="stat-label">Score total</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="player-level">1</div>
          <div class="stat-label">Niveau</div>
        </div>
      </div>
      <button class="cta-button" id="logout-btn" style="width:100%;background:var(--danger)">D√©connexion</button>
    </div>
  </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast">
  <div class="toast-icon"><i class="fas fa-check"></i></div>
  <div class="toast-message">Action r√©ussie !</div>
</div>

<script>
// =========================
// SERVEUR BACKEND R√âEL
// =========================
class RealGameServer {
  constructor() {
    this.socket = null;
    this.connected = false;
    this.serverUrl = window.location.origin;
  }

  async connect() {
    return new Promise((resolve, reject) => {
      try {
        this.socket = io(this.serverUrl);
        this.socket.on('connect', () => {
          this.connected = true;
          console.log('üîó Connect√© au serveur MorpionHub');
          this.setupSocketEvents();
          resolve();
        });
        this.socket.on('connect_error', reject);
      } catch (error) {
        reject(error);
      }
    });
  }

  setupSocketEvents() {
    // Multijoueur
    this.socket.on('waiting-for-player', (data) => {
      if (window.morpionGame && window.morpionGame.mode === 'online') {
        document.getElementById('morpion-status').textContent = data.message;
      }
    });

    this.socket.on('game-started', (data) => {
      if (window.morpionGame && window.morpionGame.mode === 'online') {
        window.morpionGame.handleGameStartMulti(data);
      }
    });

    this.socket.on('move-made-multi', (data) => {
      if (window.morpionGame && window.morpionGame.mode === 'online') {
        window.morpionGame.handleOpponentMoveMulti(data);
      }
    });

    this.socket.on('game-reset-multi', (data) => {
      if (window.morpionGame && window.morpionGame.mode === 'online') {
        window.morpionGame.handleGameResetMulti(data);
      }
    });

    this.socket.on('new-message-multi', (data) => {
      if (window.chatSystem) {
        window.chatSystem.addMessage(data);
      }
    });

    this.socket.on('opponent-left', (data) => {
      window.store.showToast(data.message, 'warning');
      if (window.morpionGame) {
        window.morpionGame.mode = 'robot-easy';
        document.getElementById('morpion-chat').style.display = 'none';
      }
    });
  }

  // Multijoueur
  async joinMorpionMulti(playerName) {
    if (!this.connected) await this.connect();
    this.socket.emit('join-morpion-multi', { playerName });
  }

  sendMoveMulti(gameId, move) {
    if (this.connected) {
      this.socket.emit('morpion-move-multi', { gameId, move });
    }
  }

  sendMessageMulti(gameId, message) {
    if (this.connected) {
      this.socket.emit('send-message-multi', { gameId, message });
    }
  }
}

// =========================
// JEU MORPION MULTIJOUEUR
// =========================
let morpionGame = {
  board: [],
  currentPlayer: 'X',
  gameActive: false,
  mode: 'robot-easy',
  score: 0,
  gameId: null,
  players: [],

  init() {
    this.board = Array(9).fill('');
    this.currentPlayer = 'X';
    this.gameActive = true;
    this.updateDisplay();
    this.updateStatus();
  },

  // Mode solo contre IA
  makeMove(position) {
    if (!this.gameActive || this.board[position] !== '') return false;

    this.board[position] = this.currentPlayer;
    this.updateDisplay();

    const winner = this.checkWinner();
    if (winner) {
      this.handleGameEnd(winner);
      return true;
    }

    if (this.isBoardFull()) {
      this.handleGameEnd(null);
      return true;
    }

    this.switchPlayer();
    this.updateStatus();

    // Tour de l'IA
    if (this.mode.startsWith('robot') && this.currentPlayer === 'O') {
      setTimeout(() => {
        const aiMove = this.getAIMove();
        this.makeMove(aiMove);
      }, 500);
    }

    return true;
  },

  // Mode multijoueur
  makeMoveMulti(position) {
    if (!this.gameActive || this.board[position] !== '' || this.currentPlayer !== this.getMySymbol()) return false;

    // Envoyer le mouvement au serveur
    window.server.sendMoveMulti(this.gameId, position);
    return true;
  },

  handleGameStartMulti(data) {
    this.gameId = data.gameId;
    this.players = data.players;
    this.board = data.board;
    this.currentPlayer = data.currentPlayer;
    this.gameActive = true;
    
    // Afficher le chat
    document.getElementById('morpion-chat').style.display = 'block';
    document.getElementById('online-players').style.display = 'block';
    document.getElementById('player-count').textContent = '2';
    
    // Mettre √† jour l'affichage
    this.updateDisplay();
    this.updateStatusMulti();
    
    window.store.showToast('Partie multijoueur commenc√©e!', 'success');
  },

  handleOpponentMoveMulti(data) {
    this.board[data.move] = data.symbol;
    this.currentPlayer = data.currentPlayer;
    this.updateDisplay();
    
    if (data.winner) {
      this.handleGameEndMulti(data.winner);
    } else if (data.isDraw) {
      this.handleGameEndMulti(null);
    } else {
      this.updateStatusMulti();
    }
  },

  handleGameResetMulti(data) {
    this.board = data.board;
    this.currentPlayer = data.currentPlayer;
    this.gameActive = true;
    this.updateDisplay();
    this.updateStatusMulti();
    window.store.showToast('Nouvelle partie!', 'info');
  },

  getMySymbol() {
    const user = window.auth.getCurrentUser();
    if (!user || !this.players) return 'X';
    const player = this.players.find(p => p.name === user.username);
    return player ? player.symbol : 'X';
  },

  getAIMove() {
    // IA simple - choisit une case al√©atoire
    const availableMoves = this.board
      .map((cell, index) => cell === '' ? index : null)
      .filter(index => index !== null);
    return availableMoves[Math.floor(Math.random() * availableMoves.length)];
  },

  checkWinner() {
    const lines = [
      [0,1,2],[3,4,5],[6,7,8],
      [0,3,6],[1,4,7],[2,5,8],
      [0,4,8],[2,4,6]
    ];

    for (const [a,b,c] of lines) {
      if (this.board[a] && this.board[a] === this.board[b] && this.board[a] === this.board[c]) {
        return this.board[a];
      }
    }
    return null;
  },

  isBoardFull() {
    return this.board.every(cell => cell !== '');
  },

  switchPlayer() {
    this.currentPlayer = this.currentPlayer === 'X' ? 'O' : 'X';
  },

  handleGameEnd(winner) {
    this.gameActive = false;
    if (winner === 'X') {
      this.score += 10;
      this.updateScoreDisplay();
    }
    this.updateStatus(winner);
  },

  handleGameEndMulti(winner) {
    this.gameActive = false;
    this.updateStatusMulti(winner);
  },

  updateDisplay() {
    const boardElement = document.getElementById('morpion-board');
    if (!boardElement) return;

    boardElement.innerHTML = '';
    this.board.forEach((cell, index) => {
      const cellElement = document.createElement('div');
      cellElement.className = `cell ${cell.toLowerCase()}`;
      cellElement.textContent = cell;
      cellElement.addEventListener('click', () => this.handleCellClick(index));
      boardElement.appendChild(cellElement);
    });
  },

  handleCellClick(position) {
    if (this.mode === 'online') {
      this.makeMoveMulti(position);
    } else {
      this.makeMove(position);
    }
  },

  updateStatus(winner = null) {
    const statusElement = document.getElementById('morpion-status');
    if (!statusElement) return;

    if (winner) {
      statusElement.textContent = winner === 'X' ? 'Vous avez gagn√© ! üéâ' : 'L\'IA a gagn√© !';
    } else if (winner === null) {
      statusElement.textContent = 'Match nul !';
    } else {
      statusElement.textContent = this.currentPlayer === 'X' ? 'Votre tour (X)' : 'Tour de l\'IA (O)';
    }
  },

  updateStatusMulti(winner = null) {
    const statusElement = document.getElementById('morpion-status');
    if (!statusElement) return;

    const mySymbol = this.getMySymbol();
    
    if (winner) {
      statusElement.textContent = winner === mySymbol ? 'Vous avez gagn√© ! üéâ' : 'Vous avez perdu !';
    } else if (winner === null) {
      statusElement.textContent = 'Match nul !';
    } else {
      statusElement.textContent = this.currentPlayer === mySymbol ? 
        'Votre tour (' + mySymbol + ')' : 
        'Tour de l\'adversaire (' + this.currentPlayer + ')';
    }
  },

  updateScoreDisplay() {
    const scoreElement = document.getElementById('morpion-score');
    if (scoreElement) {
      scoreElement.textContent = this.score;
    }
  },

  async setMode(mode) {
    this.mode = mode;
    
    if (this.mode === 'online') {
      const user = window.auth.getCurrentUser();
      if (user) {
        try {
          await window.server.joinMorpionMulti(user.username);
          document.getElementById('morpion-status').textContent = 'En attente d\'un adversaire...';
          document.getElementById('online-players').style.display = 'block';
        } catch (error) {
          window.store.showToast('Erreur de connexion', 'error');
          this.mode = 'robot-easy';
        }
      } else {
        window.store.showToast('Connectez-vous pour jouer en ligne', 'warning');
        this.mode = 'robot-easy';
      }
    } else {
      document.getElementById('morpion-chat').style.display = 'none';
      document.getElementById('online-players').style.display = 'none';
      this.gameId = null;
    }
    
    this.init();
  }
};

// =========================
// SYST√àME DE CHAT
// =========================
class ChatSystem {
  constructor() {
    this.messages = [];
  }

  addMessage(data) {
    this.messages.push(data);
    this.updateDisplay();
  }

  updateDisplay() {
    const chatMessages = document.getElementById('morpion-chat-messages');
    if (!chatMessages) return;

    chatMessages.innerHTML = '';
    this.messages.forEach(msg => {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      messageDiv.innerHTML = `<strong>${msg.player}:</strong> ${msg.message}`;
      chatMessages.appendChild(messageDiv);
    });

    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  sendMessage() {
    const input = document.getElementById('morpion-chat-input');
    const message = input.value.trim();
    
    if (message && window.morpionGame.gameId) {
      window.server.sendMessageMulti(window.morpionGame.gameId, message);
      input.value = '';
    }
  }
}

// =========================
// SYST√àMES D'AUTHENTIFICATION ET STOCKAGE
// =========================
class AuthSystem {
  constructor() {
    this.currentUser = null;
    this.token = localStorage.getItem('gamehub-token');
    this.userData = JSON.parse(localStorage.getItem('gamehub-user') || 'null');
    if (this.userData) this.currentUser = this.userData;
  }

  async login(username, password) {
    try {
      const response = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      });
      const data = await response.json();
      if (data.success) {
        this.currentUser = data.user;
        this.token = data.token;
        localStorage.setItem('gamehub-token', data.token);
        localStorage.setItem('gamehub-user', JSON.stringify(data.user));
        this.updateUI();
        window.store.showToast('Connexion r√©ussie!', 'success');
        return true;
      } else {
        throw new Error(data.error);
      }
    } catch (error) {
      window.store.showToast(error.message, 'error');
      return false;
    }
  }

  async register(userData) {
    try {
      const response = await fetch('/api/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(userData)
      });
      const data = await response.json();
      if (data.success) {
        this.currentUser = data.user;
        this.token = data.token;
        localStorage.setItem('gamehub-token', data.token);
        localStorage.setItem('gamehub-user', JSON.stringify(data.user));
        this.updateUI();
        window.store.showToast('Compte cr√©√© avec succ√®s!', 'success');
        return true;
      } else {
        throw new Error(data.error);
      }
    } catch (error) {
      window.store.showToast(error.message, 'error');
      return false;
    }
  }

  logout() {
    this.currentUser = null;
    this.token = null;
    localStorage.removeItem('gamehub-token');
    localStorage.removeItem('gamehub-user');
    this.updateUI();
    window.store.showToast('D√©connexion r√©ussie', 'info');
  }

  isLoggedIn() {
    return this.currentUser !== null;
  }

  updateUI() {
    const userInfo = document.getElementById('user-info');
    const authBtn = document.getElementById('auth-btn');
    if (this.isLoggedIn()) {
      userInfo.style.display = 'flex';
      document.getElementById('user-name').textContent = this.currentUser.username;
      document.getElementById('user-avatar').textContent = this.currentUser.username.charAt(0).toUpperCase();
      authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
    } else {
      userInfo.style.display = 'none';
      authBtn.innerHTML = '<i class="fas fa-user"></i>';
    }
  }

  getCurrentUser() {
    return this.currentUser;
  }
}

class RealGameStore {
  constructor() {
    this.state = {
      user: null,
      settings: this.loadSettings()
    };
  }

  loadSettings() {
    const saved = localStorage.getItem('gamehub-settings');
    return saved ? JSON.parse(saved) : {
      sound: true,
      dark: false,
      music: false,
      notifications: true
    };
  }

  saveSettings() {
    localStorage.setItem('gamehub-settings', JSON.stringify(this.state.settings));
  }

  showToast(message, type = 'success') {
    const toast = document.getElementById('toast');
    toast.querySelector('.toast-message').textContent = message;
    toast.className = `toast ${type} show`;
    setTimeout(() => toast.classList.remove('show'), 3000);
  }
}

// =========================
// INITIALISATION
// =========================
let server, auth, store, chatSystem;

document.addEventListener('DOMContentLoaded', () => {
  initializeApp();
});

async function initializeApp() {
  try {
    server = new RealGameServer();
    auth = new AuthSystem();
    store = new RealGameStore();
    chatSystem = new ChatSystem();

    window.server = server;
    window.auth = auth;
    window.store = store;
    window.chatSystem = chatSystem;
    window.morpionGame = morpionGame;

    applySettings();
    setupEventListeners();
    auth.updateUI();

    console.log('üéÆ MorpionHub Multijoueur initialis√©!');

  } catch (error) {
    console.error('Erreur:', error);
    store.showToast('Erreur de chargement', 'error');
  }
}

function applySettings() {
  document.body.classList.toggle('dark-mode', store.state.settings.dark);
  document.getElementById('theme-toggle').innerHTML = store.state.settings.dark ? 
    '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
}

function setupEventListeners() {
  // Navigation
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.addEventListener('click', () => switchTab(tab.dataset.tab));
  });

  // Contr√¥les
  document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
  document.getElementById('auth-btn').addEventListener('click', handleAuthButton);
  document.getElementById('start-btn').addEventListener('click', () => switchTab('games'));

  // Jeux
  document.querySelectorAll('.game-card[data-game="morpion"]').forEach(card => {
    card.addEventListener('click', () => openGame('morpion'));
  });

  document.querySelectorAll('.join-room').forEach(btn => {
    btn.addEventListener('click', function() {
      joinMultiplayerRoom('morpion');
    });
  });

  // Morpion
  document.getElementById('morpion-back').addEventListener('click', closeGames);
  document.getElementById('morpion-reset').addEventListener('click', () => morpionGame.init());
  document.querySelectorAll('#morpion .mode-button').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('#morpion .mode-button').forEach(b => b.classList.remove('active'));
      this.classList.add('active');
      morpionGame.setMode(this.dataset.mode);
    });
  });

  // Chat
  document.getElementById('morpion-chat-send').addEventListener('click', () => chatSystem.sendMessage());
  document.getElementById('morpion-chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') chatSystem.sendMessage();
  });

  // Authentification
  document.getElementById('auth-submit').addEventListener('click', handleAuthSubmit);
  document.getElementById('auth-switch').addEventListener('click', toggleAuthMode);
  document.getElementById('logout-btn').addEventListener('click', () => auth.logout());
  document.querySelectorAll('.modal-close').forEach(btn => {
    btn.addEventListener('click', () => {
      btn.closest('.modal').classList.remove('active');
    });
  });
}

// Fonctions d'interface
function switchTab(tabName) {
  document.querySelectorAll('.nav-tab').forEach(tab => {
    tab.classList.toggle('active', tab.dataset.tab === tabName);
  });
  document.querySelectorAll('.section').forEach(section => {
    section.classList.toggle('active', section.id === tabName);
  });
}

function openGame(gameId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById('morpion').classList.add('active');
  
  if (gameId === 'morpion-multi') {
    morpionGame.setMode('online');
  } else {
    morpionGame.setMode('robot-easy');
  }
}

function closeGames() {
  switchTab('games');
}

function joinMultiplayerRoom(game) {
  if (!auth.isLoggedIn()) {
    store.showToast('Connectez-vous pour jouer en ligne', 'warning');
    openAuthModal();
    return;
  }
  openGame('morpion-multi');
}

function toggleTheme() {
  store.state.settings.dark = !store.state.settings.dark;
  store.saveSettings();
  applySettings();
}

function handleAuthButton() {
  if (auth.isLoggedIn()) {
    openProfileModal();
  } else {
    openAuthModal();
  }
}

function openAuthModal() {
  document.getElementById('auth-modal').classList.add('active');
}

function openProfileModal() {
  const user = auth.getCurrentUser();
  if (user) {
    document.getElementById('total-games').textContent = user.stats.totalGames;
    document.getElementById('win-rate').textContent = user.stats.totalGames > 0 ? 
      Math.round((user.stats.wins / user.stats.totalGames) * 100) + '%' : '0%';
    document.getElementById('total-score').textContent = user.stats.totalScore;
    document.getElementById('player-level').textContent = user.stats.level;
  }
  document.getElementById('profile-modal').classList.add('active');
}

async function handleAuthSubmit() {
  const username = document.getElementById('auth-username').value.trim();
  const password = document.getElementById('auth-password').value;
  if (!username || !password) {
    store.showToast('Veuillez remplir tous les champs', 'warning');
    return;
  }
  const isLogin = document.getElementById('auth-submit').textContent === 'Se connecter';
  const success = isLogin ? 
    await auth.login(username, password) : 
    await auth.register({ username, password, email: `${username}@gamehub.com` });
  if (success) {
    document.getElementById('auth-modal').classList.remove('active');
  }
}

function toggleAuthMode() {
  const title = document.getElementById('auth-modal-title');
  const submit = document.getElementById('auth-submit');
  const switchBtn = document.getElementById('auth-switch');
  if (submit.textContent === 'Se connecter') {
    title.textContent = 'Cr√©er un compte';
    submit.textContent = 'Cr√©er le compte';
    switchBtn.textContent = 'Se connecter';
  } else {
    title.textContent = 'Connexion';
    submit.textContent = 'Se connecter';
    switchBtn.textContent = 'Cr√©er un compte';
  }
}

// Gestion des erreurs
window.addEventListener('error', (e) => {
  console.error('Erreur:', e.error);
  store.showToast('Une erreur est survenue', 'error');
});

console.log('üöÄ MorpionHub - Pr√™t √† fonctionner!');
</script>
</body>
</html>
